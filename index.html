<html>
<head>
<title>Health Compass</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<meta name=viewport
  content="width=device-width, initial-scale=1.0, minimum-scale=0.5 maximum-scale=1.0">
<style>
#topbar {
width: 100%;
height: 120px;
padding: 10px;
background: rgb(0,94,184);
position:fixed;
top:0;
z-index:1;
}
#map {
height: 100%;
position: fixed;
}


#symptoms {
position: fixed;
top: 20%;
width: 80%;
border-radius: 20px;
background: white;
z-index: 999;
    height: 90px;
    left: 9%;
    border: 1px solid black;
    padding: 0 20px;
    font-size: 200%;
}

*:focus {
    outline: none;
}

#bottombars {
    width: 100%;
    position: fixed;
    bottom: 5%;
    text-align: center;
    display:none;
}

#pharmacists, #findappts, #walkin {
    display: inline-block;
    width: 300px;
    height: 80px;
    background: white;
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 10px;
    color: black;
    display: none;
    border: 1px solid black;
}
#pharmacists:hover, #findappts:hover, #walkin:hover {
    background: #ddd;
    text-decoration: none;
}

.overlay {
position:absolute;
top: 0;
width: 100%;
height: auto;
min-height: 100%;
background: rgba(0,0,0,0.3);
z-index: 1000;
text-align: center;
display: none;
}

.place {
font-size: 150%;
}
.offer {
font-size: 100%;
}
.rating {
font-size: 70%;
}

.offerdiv {
display: inline-block;
text-align: center;
background: white;
border-radius: 20px;
padding: 20px;
max-width: 600px;
width: 80%;
margin-top: 20px;
margin-left: 20px;
margin-bottom: 30px;
color: black;
}

.offerdiv:hover {
text-decoration: none;
}

::-webkit-input-placeholder {
   text-align: center;
}

:-moz-placeholder { /* Firefox 18- */
   text-align: center;  
}

::-moz-placeholder {  /* Firefox 19+ */
   text-align: center;  
}

:-ms-input-placeholder {  
   text-align: center; 
}
</style>
</head>
<body>
<div id="topbar">
<img src="logo.jpg" height="100px" />
<img src="person.jpg" height="100px" style="border-radius: 50%" align="right" />
</div>
<div id="main">

    <div id="map"></div>
    <script>
      var map, infoWindow, pos;
      var markers = []
      
      var rad = function(x) {
  return x * Math.PI / 180;
};

var getDistance = function(p1, p2) {
  var R = 6378137; // Earthâ€™s mean radius in meter
  var dLat = rad(p2.lat - p1.lat);
  var dLong = rad(p2.lng - p1.lng);
  var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.cos(rad(p1.lat)) * Math.cos(rad(p2.lat)) *
    Math.sin(dLong / 2) * Math.sin(dLong / 2);
  var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  var d = R * c;
  return d; // returns the distance in meter
};
      
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 14,
          
    mapTypeControlOptions: {
         mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'tehgrayz']
    }
        });
        
        var stylez = [
    {
      featureType: "all",
      elementType: "all",
      stylers: [
        { saturation: -100 } // <-- THIS
      ]
    }
];
            var mapType = new google.maps.StyledMapType(stylez, { name:"Grayscale" });    
map.mapTypes.set('tehgrayz', mapType);
map.setMapTypeId('tehgrayz')

        
        infoWindow = new google.maps.InfoWindow;

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            map.setCenter(pos);
            
      var marker = new google.maps.Marker({
          position: pos,
          map: map,
          clickable: false,
    icon: 'marker.png'
        });
        infowindow = new google.maps.InfoWindow();
        /*var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
          location: pos,
          radius: 2000,
          type: ['doctor']
        }, callback);*/
        
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }
      
      
      function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
        
          $.getJSON( "appts.json?a="+Math.random(), function( data ) {
            var items = [];
            $("#overlay_appt").html("");
            $.each( data, function( key, val ) {
               for (var i = 0; i < results.length; i++) {
                 if(results[i].name == val.name){
                    createMarker(results[i], 'yellow.png', 999);
                    var dd = getDistance(pos, {lat: results[i].geometry.location.lat(), lng: results[i].geometry.location.lng()});
                    var today = new Date();
                    var tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);

                    var d = new Date(val.time);
                    var datestring = ""
                    if(d.toDateString() == today.toDateString()) datestring += "<b>today</b>";
                    else if(d.toDateString() == tomorrow.toDateString())  datestring += "<b>tomorrow</b>";
                    else datestring += "<b>" + ("0" + d.getDate()).slice(-2) + "-" + ("0"+(d.getMonth()+1)).slice(-2) + "-" +
    d.getFullYear() + "</b> ";
                     datestring += " at <b>" + ("0" + d.getHours()).slice(-2) + ":" + ("0" + d.getMinutes()).slice(-2) + "hrs</b>";
                    $("#overlay_appt").append('<div class="offerdiv"><span class="place">'+results[i].name+'</span><br /><span class="offer">Appointment available at '+datestring+' - '+(dd*1.609/1000).toFixed(2)+' miles away</span><br /><span class="rating">'+results[i].rating+' stars<br />Click to book</span></div>')
                    }
               }
            });
          });
        }
      }
      
      function callback2(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
        
          
            $("#overlay_pharm").html("");
            results.sort(
          function(x, y)
          {
          
              var a = getDistance(pos, {lat: x.geometry.location.lat(), lng: x.geometry.location.lng()})
              var b = getDistance(pos, {lat: y.geometry.location.lat(), lng: y.geometry.location.lng()})
             return a - b;
          }
        );
               for (var i = 0; i < results.length; i++) {
                    createMarker(results[i], 'blue.png');
                    var dd = getDistance(pos, {lat: results[i].geometry.location.lat(), lng: results[i].geometry.location.lng()});
                    $("#overlay_pharm").append('<a href="https://www.google.com/maps/place/?q=place_id:'+results[i].place_id+'" target="_blank" class="offerdiv"><span class="place">'+results[i].name+'</span><br /><span class="offer">Currently <b>'+(results[i].opening_hours.open_now==true?"open":"closed")+'</b> - '+(dd*1.609/1000).toFixed(2)+' miles away</span><br /><span class="rating">'+results[i].rating+' stars<br />Click to view more</span></a>')
                    
               }
          }
      }

      
      function callback3(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
        
          
               for (var i = 0; i < Math.min(3,results.length); i++) {
                    createMarker(results[i], 'red.png');
               }
          }
      }
      
      function callback4(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
               for (var i = 0; i < Math.min(3,results.length); i++) {
                    createMarker(results[i], 'green.png');
               }
          }
      }

      function createMarker(place, icon, zIndex=0) {
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location,
          icon: icon, zIndex: zIndex
        });
        markers.push(marker);

        google.maps.event.addListener(marker, 'click', function() {
          infowindow.setContent("<b style='font-size: 120%'>"+place.name+"</b><br />"+place.vicinity+"<br /><br />Open now? <b>"+(place.opening_hours.open_now==true?"yes":"no")+"</b>");
          infowindow.open(map, this);
        });
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }
      
      function moveBarUp(){
          if($("#symptoms").offset().top > 17) {
              $("#symptoms").css("top", $("#symptoms").offset().top - 4 + "px")
              setTimeout(moveBarUp, 10);
          } else {
          for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
          }
          
          $("#findappts").css("display", "inline-block");
          $("#bottombars").fadeIn();
          var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
          location: pos,
          radius: 2000,
          type: ['doctor']
        }, callback);
        
        $.getJSON( "http://localhost:5000/p/"+encodeURI($("#symptoms").val()), function( data ) {
        console.log(data)
            var items = [];
            var shownp = 0;
        if ( data == "1" || $("#symptoms").val().indexOf( "vaccin" ) > -1  || $("#symptoms").val().indexOf( "smoking" ) > -1  ) {
  service.nearbySearch({
          location: pos,
          radius: 2000,
          type: ['pharmacy']
        }, callback2);
        
        $("#pharmacists").css("display", "inline-block");
        shownp = 1;
}
if(shownp == 0) {$("#pharmacists").css("display", "none"); }
        
        })
        
        $.getJSON( "http://localhost:5000/wi/"+encodeURI($("#symptoms").val()), function( data ) {
        console.log(data)
            var items = [];
            var shownp = 0;
        if ( data == "1" || $("#symptoms").val().indexOf( "vaccin" ) > -1  || $("#symptoms").val().indexOf( "smoking" ) > -1  ) {
  service.nearbySearch({
          location: pos,
          radius: 2000,
          name: 'Walk-in centre'
        }, callback4);
        
        $("#walkin").css("display", "inline-block");
        shownp = 1;
}
if(shownp == 0) {$("#walkin").css("display", "none"); }
        
        })
        
        
        service.nearbySearch({
          location: pos,
          radius: 2000,
          name: "A&E"
        }, callback3);
        
           // search for gp appointments
           // display on map
           // if pharmacy handlable, show pharmacies
           // if not, want an alert?
           
          }
      }
      $(document).ready(function(){
      $(".overlay").click(function(e){if(e.target !== e.currentTarget) return; $(".overlay").fadeOut()});
      
      $("#symptoms").keypress(function(ev){
            var keycode = (ev.keyCode ? ev.keyCode : ev.which);
          if(keycode == 13) {
          
              map.setMapTypeId(google.maps.MapTypeId.ROADMAP)
              moveBarUp();
          }
      });
      });
      
      function showOverlayAppt(){
      $("#overlay_appt").fadeIn()
      }
      function showOverlayPharm(){
      $("#overlay_pharm").fadeIn();
      $("#map").css("position","fixed")
      $("#map").css("top","0")
      $("#map").css("width","100%")
      $("#map").css("height","100%")
      }
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI8Aky613VYT8bNhMl6-RK5X8jr-JIZL4&callback=initMap&libraries=places">
    
    </script>
    
    <input type="text"  placeholder="What's wrong? :(" id="symptoms" />
    
    <div id="bottombars">
    <a href="javascript:showOverlayPharm()" id="pharmacists">Pharmacies<br /><span style="font-size:80%">Can help with your problem more quickly</span></a>
    <a href="#" id="walkin">Walk-in Centres<br /><span style="font-size:80%">Might be able to see you faster than a GP</span></a>
    <a href="javascript:showOverlayAppt()" id="findappts">Find appointments<br /><span style="font-size:80%">Last minute appointments with your GP</span></a>
    </div>
    
</div>

    
    <div id="overlay_appt" class="overlay">
    </div>
    <div id="overlay_pharm" class="overlay">
    </div>
    <div id="overlay_wic" class="overlay">
    </div>
<div id="footer">

</div>
</body>
</html>