<html>
<head>
<title>Health Compass</title>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<meta name=viewport
  content="width=device-width, initial-scale=1.0, minimum-scale=0.5 maximum-scale=1.0">
<style>
#topbar {
width: 100%;
height: 120px;
padding: 10px;
background: rgb(0,94,184);
position:fixed;
top:0;
z-index:1;
}
#map {
height: 100%;
position: fixed;
}


#symptoms {
position: fixed;
top: 20%;
width: 80%;
border-radius: 20px;
background: white;
z-index: 999;
    height: 90px;
    left: 9%;
    border: 1px solid black;
    padding: 0 20px;
    font-size: 200%;
}

*:focus {
    outline: none;
}

#bottombars {
    width: 100%;
    position: fixed;
    bottom: 5%;
    text-align: center;
    display:none;
}

#pharmacists, #findappts {
    display: inline-block;
    width: 300px;
    height: 80px;
    background: white;
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 10px;
    color: black;
    display: none;
}
#pharmacists:hover, #findappts:hover {
    background: #ddd;
    text-decoration: none;
}
</style>
</head>
<body>
<div id="topbar">
<img src="logo.jpg" height="100px" />
<img src="person.jpg" height="100px" style="border-radius: 50%" align="right" />
</div>
<div id="main">

    <div id="map"></div>
    <script>
      var map, infoWindow, pos;
      var markers = []
      
      function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
          center: {lat: -34.397, lng: 150.644},
          zoom: 14,
          
    mapTypeControlOptions: {
         mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'tehgrayz']
    }
        });
        
        var stylez = [
    {
      featureType: "all",
      elementType: "all",
      stylers: [
        { saturation: -100 } // <-- THIS
      ]
    }
];
            var mapType = new google.maps.StyledMapType(stylez, { name:"Grayscale" });    
map.mapTypes.set('tehgrayz', mapType);
map.setMapTypeId('tehgrayz')

        
        infoWindow = new google.maps.InfoWindow;

        // Try HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(function(position) {
            pos = {
              lat: position.coords.latitude,
              lng: position.coords.longitude
            };
            map.setCenter(pos);
            
      var marker = new google.maps.Marker({
          position: pos,
          map: map,
          clickable: false,
    icon: 'marker.png'
        });
        infowindow = new google.maps.InfoWindow();
        /*var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
          location: pos,
          radius: 2000,
          type: ['doctor']
        }, callback);*/
        
          }, function() {
            handleLocationError(true, infoWindow, map.getCenter());
          });
        } else {
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }
      
      
      function callback(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
        
          $.getJSON( "appts.json?a="+Math.random(), function( data ) {
            var items = [];
            $.each( data, function( key, val ) {
               for (var i = 0; i < results.length; i++) {
                 if(results[i].name == val.name){
                    createMarker(results[i], 'yellow.png', 999);
                    }
               }
            });
          });
        }
      }
      
      function callback2(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
        
          
               for (var i = 0; i < results.length; i++) {
                    createMarker(results[i], 'blue.png');
               }
          }
      }

      
      function callback3(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK) {
        
          
               for (var i = 0; i < Math.min(3,results.length); i++) {
                    createMarker(results[i], 'red.png');
               }
          }
      }

      function createMarker(place, icon, zIndex=0) {
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
          map: map,
          position: place.geometry.location,
          icon: icon, zIndex: zIndex
        });
        markers.push(marker);

        google.maps.event.addListener(marker, 'click', function() {
          infowindow.setContent(place.name);
          infowindow.open(map, this);
        });
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(browserHasGeolocation ?
                              'Error: The Geolocation service failed.' :
                              'Error: Your browser doesn\'t support geolocation.');
        infoWindow.open(map);
      }
      
      function moveBarUp(){
          if($("#symptoms").offset().top > 17) {
              $("#symptoms").css("top", $("#symptoms").offset().top - 4 + "px")
              setTimeout(moveBarUp, 10);
          } else {
          for (var i = 0; i < markers.length; i++) {
          markers[i].setMap(null);
          }
          
          $("#findappts").css("display", "inline-block");
          $("#bottombars").fadeIn();
          var service = new google.maps.places.PlacesService(map);
        service.nearbySearch({
          location: pos,
          radius: 2000,
          type: ['doctor']
        }, callback);
        
        $.getJSON( "http://localhost:5000/p/"+encodeURI($("#symptoms").val()), function( data ) {
        console.log(data)
            var items = [];
            var shownp = 0;
        if ( data == "1" || $("#symptoms").val().indexOf( "vaccin" ) > -1  || $("#symptoms").val().indexOf( "smoking" ) > -1  ) {
  service.nearbySearch({
          location: pos,
          radius: 2000,
          type: ['pharmacy']
        }, callback2);
        
        $("#pharmacists").css("display", "inline-block");
        shownp = 1;
}
if(shownp == 0) {$("#pharmacists").css("display", "none"); }
        
        })
        
        
        service.nearbySearch({
          location: pos,
          radius: 2000,
          name: "A&E"
        }, callback3);
        
           // search for gp appointments
           // display on map
           // if pharmacy handlable, show pharmacies
           // if not, want an alert?
           
          }
      }
      $(document).ready(function(){
      $("#symptoms").keypress(function(ev){
            var keycode = (ev.keyCode ? ev.keyCode : ev.which);
          if(keycode == 13) {
          
              map.setMapTypeId(google.maps.MapTypeId.ROADMAP)
              moveBarUp();
          }
      });
      });
      
      
    </script>
    <script async defer
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBI8Aky613VYT8bNhMl6-RK5X8jr-JIZL4&callback=initMap&libraries=places">
    
    </script>
    
    <input type="text"  placeholder="What's wrong? :(" id="symptoms" />
    
    <div id="bottombars">
    <a href="#" id="pharmacists">Pharmacies<br /><span style="font-size:80%">Can help with your problem more quickly</span></a>
    <a href="#" id="findappts">Find appointments<br /><span style="font-size:80%">Last minute appointments with your GP</span></a>
    </div>
    
    
</div>
<div id="footer">

</div>
</body>
</html>